<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digibase API Demo - Real-Time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/digibase.js"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
            color: #e2e8f0;
        }

        .key-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #7c3aed;
        }

        /* Live feed animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .live-item {
            animation: slideIn 0.3s ease-out;
        }

        .live-dot {
            animation: pulse 1.5s infinite;
        }

        .event-created {
            border-left: 3px solid #22c55e;
        }

        .event-updated {
            border-left: 3px solid #3b82f6;
        }

        .event-deleted {
            border-left: 3px solid #ef4444;
        }
    </style>
</head>

<body class="min-h-screen p-8 font-sans">

    <div class="max-w-6xl mx-auto space-y-8">
        <!-- Header -->
        <div class="flex items-center justify-between">
            <div>
                <h1
                    class="text-3xl font-bold bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-500 bg-clip-text text-transparent">
                    üì° Digibase Live Demo
                </h1>
                <p class="text-slate-400 mt-2">Real-time API with WebSocket subscriptions</p>
            </div>
            <div class="flex gap-3">
                <a href="/admin"
                    class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg transition text-sm">
                    üîß Admin
                </a>
                <a href="/admin/api-keys"
                    class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg transition text-sm">
                    üîë Keys
                </a>
            </div>
        </div>

        <!-- API Key Configuration -->
        <div class="glass p-6 rounded-xl">
            <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                üîë Configuration
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2">
                    <label class="text-sm text-slate-400 block mb-2">API Key</label>
                    <input type="text" id="api-key-input"
                        class="key-input w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-slate-200 font-mono text-sm"
                        placeholder="pk_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" value="pk_0dwUvsUlra7AeGmkgXXJjBC3HjheSaMq">
                </div>
                <div>
                    <label class="text-sm text-slate-400 block mb-2">Table</label>
                    <input type="text" id="table-input"
                        class="key-input w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-slate-200"
                        placeholder="authors" value="authors">
                </div>
            </div>
            <div class="flex gap-3 mt-4">
                <button onclick="loadData()"
                    class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg transition font-medium">
                    üì• Fetch Data
                </button>
                <button onclick="startSubscription()" id="subscribe-btn"
                    class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-lg transition font-medium flex items-center gap-2">
                    <span class="w-2 h-2 bg-white rounded-full"></span>
                    Subscribe Live
                </button>
                <button onclick="stopSubscription()" id="unsubscribe-btn"
                    class="hidden bg-red-600 hover:bg-red-500 text-white px-6 py-3 rounded-lg transition font-medium">
                    ‚èπ Unsubscribe
                </button>
            </div>
        </div>

        <!-- Status -->
        <div id="status" class="hidden p-4 rounded-lg"></div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left: Data List -->
            <div class="lg:col-span-2 space-y-4">
                <h2 class="text-xl font-semibold text-slate-200 flex items-center gap-2">
                    üìö <span id="table-title">Data</span>
                </h2>
                <div id="data-list" class="space-y-3">
                    <div class="glass p-8 rounded-xl text-center text-slate-500">
                        Enter your API key and click "Fetch Data" to begin
                    </div>
                </div>
            </div>

            <!-- Right: Live Feed -->
            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-slate-200 flex items-center gap-2">
                    <span id="live-indicator" class="w-3 h-3 bg-slate-500 rounded-full"></span>
                    Live Feed
                </h2>
                <div id="live-feed" class="glass rounded-xl p-4 h-96 overflow-y-auto space-y-3">
                    <div class="text-center text-slate-500 text-sm py-8">
                        <p class="text-2xl mb-2">üì°</p>
                        <p>Click "Subscribe Live" to receive</p>
                        <p>real-time updates</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SDK Code Example -->
        <div class="glass p-6 rounded-xl">
            <h2 class="text-lg font-semibold text-white mb-4">üíª Real-Time SDK Usage</h2>
            <pre class="bg-slate-900 rounded-lg p-4 text-sm overflow-x-auto"><code class="text-green-400">// Initialize SDK
const db = new Digibase('/api/data')
    .setToken('pk_your_key_here')
    .configureRealtime({ host: 'localhost', port: 8080 });

// Subscribe to ALL changes
db.from('authors').subscribe((event) => {
    console.log(event.action, event.data);
    // action: 'created' | 'updated' | 'deleted'
});

// Or listen for specific events
db.from('authors')
    .on('created', (data) => console.log('New author:', data))
    .on('updated', (data) => console.log('Updated:', data))
    .on('deleted', (data) => console.log('Deleted ID:', data.id));</code></pre>
        </div>
    </div>

    <script>
        let db;
        let isSubscribed = false;

        function initSDK() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            db = new Digibase('/api/data')
                .setToken(apiKey)
                .configureRealtime({ host: window.location.hostname, port: 8080 });
            return db;
        }

        async function loadData() {
            const table = document.getElementById('table-input').value.trim() || 'authors';
            const statusEl = document.getElementById('status');
            const listEl = document.getElementById('data-list');
            const titleEl = document.getElementById('table-title');

            initSDK();
            titleEl.textContent = table.charAt(0).toUpperCase() + table.slice(1);

            // Show loading
            statusEl.classList.remove('hidden');
            statusEl.className = 'p-4 rounded-lg bg-blue-500/10 border border-blue-500/20 text-blue-400';
            statusEl.innerHTML = '‚è≥ Fetching data...';

            try {
                const data = await db.from(table).include('books').get();

                // Success!
                statusEl.className = 'p-4 rounded-lg bg-green-500/10 border border-green-500/20 text-green-400';
                statusEl.innerHTML = `‚úÖ Fetched ${data.length} record(s) from <strong>${table}</strong>`;

                if (data.length === 0) {
                    listEl.innerHTML = `
                        <div class="glass p-8 rounded-xl text-center text-slate-500">
                            <p class="text-2xl mb-2">üì≠</p>
                            <p>No records found in <strong>${table}</strong></p>
                        </div>`;
                    return;
                }

                listEl.innerHTML = data.map(item => renderDataCard(item)).join('');

            } catch (error) {
                console.error('API Error:', error);
                statusEl.className = 'p-4 rounded-lg bg-red-500/10 border border-red-500/20 text-red-400';
                statusEl.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        function renderDataCard(item) {
            const keys = Object.keys(item).filter(k => !['books', 'created_at', 'updated_at', 'deleted_at'].includes(k));
            return `
                <div class="glass p-4 rounded-xl hover:bg-white/5 transition" data-id="${item.id}">
                    <div class="flex justify-between items-start">
                        <div class="space-y-1">
                            ${keys.map(k => `
                                <div class="text-sm">
                                    <span class="text-slate-500">${k}:</span>
                                    <span class="text-slate-200 font-mono">${JSON.stringify(item[k])}</span>
                                </div>
                            `).join('')}
                        </div>
                        <span class="text-xs font-mono text-slate-500">ID: ${item.id}</span>
                    </div>
                    ${item.books && item.books.length > 0 ? `
                        <div class="mt-3 pt-3 border-t border-slate-700/50">
                            <p class="text-xs text-slate-500 uppercase mb-1">Related (${item.books.length})</p>
                            <div class="flex flex-wrap gap-1">
                                ${item.books.slice(0, 3).map(b => `
                                    <span class="text-xs bg-slate-700 px-2 py-1 rounded">${b.title || b.name || b.id}</span>
                                `).join('')}
                                ${item.books.length > 3 ? `<span class="text-xs text-slate-500">+${item.books.length - 3} more</span>` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function startSubscription() {
            const table = document.getElementById('table-input').value.trim() || 'authors';
            const feedEl = document.getElementById('live-feed');
            const indicator = document.getElementById('live-indicator');
            const subscribeBtn = document.getElementById('subscribe-btn');
            const unsubscribeBtn = document.getElementById('unsubscribe-btn');

            initSDK();

            // Clear feed
            feedEl.innerHTML = '';
            addToFeed('üì° Connecting to real-time channel...', 'info');

            try {
                db.from(table)
                    .on('created', (data, event) => {
                        addToFeed(`‚ú® Created: ID ${data.id}`, 'created', data);
                        highlightCard(data.id, 'created');
                    })
                    .on('updated', (data, event) => {
                        addToFeed(`üìù Updated: ID ${data.id}`, 'updated', data);
                        highlightCard(data.id, 'updated');
                    })
                    .on('deleted', (data, event) => {
                        addToFeed(`üóëÔ∏è Deleted: ID ${data.id}`, 'deleted', data);
                        removeCard(data.id);
                    });

                // Update UI
                isSubscribed = true;
                indicator.className = 'w-3 h-3 bg-emerald-500 rounded-full live-dot';
                subscribeBtn.classList.add('hidden');
                unsubscribeBtn.classList.remove('hidden');

                setTimeout(() => {
                    addToFeed(`üü¢ Subscribed to <strong>public-data.${table}</strong>`, 'success');
                }, 500);

            } catch (error) {
                addToFeed(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function stopSubscription() {
            const table = document.getElementById('table-input').value.trim() || 'authors';
            const indicator = document.getElementById('live-indicator');
            const subscribeBtn = document.getElementById('subscribe-btn');
            const unsubscribeBtn = document.getElementById('unsubscribe-btn');

            if (db) {
                db.unsubscribe(table);
            }

            isSubscribed = false;
            indicator.className = 'w-3 h-3 bg-slate-500 rounded-full';
            subscribeBtn.classList.remove('hidden');
            unsubscribeBtn.classList.add('hidden');

            addToFeed('‚èπ Unsubscribed', 'info');
        }

        function addToFeed(message, type, data = null) {
            const feedEl = document.getElementById('live-feed');
            const time = new Date().toLocaleTimeString();
            
            const itemClass = {
                'created': 'event-created bg-green-500/5',
                'updated': 'event-updated bg-blue-500/5',
                'deleted': 'event-deleted bg-red-500/5',
                'info': 'bg-slate-500/5 border-l-3 border-slate-500',
                'success': 'bg-emerald-500/5 border-l-3 border-emerald-500',
                'error': 'bg-red-500/5 border-l-3 border-red-500',
            }[type] || 'bg-slate-500/5';

            const html = `
                <div class="live-item ${itemClass} p-3 rounded-lg text-sm">
                    <div class="flex justify-between items-center mb-1">
                        <span>${message}</span>
                        <span class="text-xs text-slate-500">${time}</span>
                    </div>
                    ${data ? `<pre class="text-xs text-slate-400 mt-2 overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>` : ''}
                </div>
            `;

            feedEl.insertAdjacentHTML('afterbegin', html);

            // Keep only last 50 items
            while (feedEl.children.length > 50) {
                feedEl.removeChild(feedEl.lastChild);
            }
        }

        function highlightCard(id, action) {
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                const color = action === 'created' ? 'ring-green-500' : 'ring-blue-500';
                card.classList.add('ring-2', color);
                setTimeout(() => card.classList.remove('ring-2', color), 2000);
            } else if (action === 'created') {
                // Refresh to show new item
                loadData();
            }
        }

        function removeCard(id) {
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                card.classList.add('opacity-50', 'line-through');
                setTimeout(() => card.remove(), 1000);
            }
        }
    </script>
</body>

</html>